# E2E Testing Coverage

## Problem Context

The project progressed significantly without adequate E2E test coverage. Core features like note editing, multi-select, playback controls, and persistence were untested, creating risk for regressions.

## Approach

Audit existing features and tests, identify gaps, then write E2E tests for critical user interactions using Playwright.

## Testing Strategy: JSON Debug API

### Problem with Current Tests

Current tests rely on mouse position calculations:

```typescript
const startX = gridBox.x + BEAT_WIDTH * 0.5;
await page.mouse.move(startX, startY);
await page.mouse.down();
// ...
```

Issues:

- Fragile: breaks if UI dimensions change
- Verbose: lots of boilerplate for simple operations
- Hard to verify: checking state requires inspecting DOM

### Solution: Expose Store for Debug/Test

Expose the Zustand store on `window` in development mode:

```typescript
// In app.tsx or project-store.ts
if (import.meta.env.DEV) {
  window.__store = useProjectStore;
}
```

Tests can then manipulate state directly via a single helper:

```typescript
// Helper (in e2e/helpers.ts)
async function evaluateStore<T>(
  page: Page,
  fn: (store: typeof useProjectStore) => T,
): Promise<T> {
  return page.evaluate(fn, window.__store);
}

// Usage: read state
const notes = await evaluateStore(page, (store) => store.getState().notes);
expect(notes).toHaveLength(2);

// Usage: mutate state
await evaluateStore(page, (store) => {
  store.getState().addNote({ id: "n1", pitch: 48, start: 0, duration: 1 });
  store.getState().setTempo(140);
});
```

### Benefits

1. **Robust**: No dependency on pixel positions or UI layout
2. **Concise**: Direct state manipulation, less boilerplate
3. **Verifiable**: Assert on actual state, not just DOM
4. **Fast**: Skip UI interactions for setup/teardown

### Scope

- Debug/development feature only, not exposed to end users
- Full JSON access to project state (notes, tempo, settings, etc.)
- Both read and write access for complete test control

### Implementation Plan

1. Expose `useProjectStore` on `window.__store` in dev mode
2. Add TypeScript types for `window.__store`
3. Create single `evaluateStore(page, fn)` helper in `e2e/helpers.ts`
4. Refactor tests per plan below
5. Consolidate test files

### Test Refactoring Plan

**Rewrite with `evaluateStore`** (not testing mouse UX):

| File                | Test                                       | Change                            |
| ------------------- | ------------------------------------------ | --------------------------------- |
| persistence.spec.ts | `notes persist after page reload`          | Setup & verify via store          |
| persistence.spec.ts | `multiple notes persist after reload`      | Setup & verify via store          |
| persistence.spec.ts | `tempo persists after reload`              | Verify via store                  |
| persistence.spec.ts | `grid snap persists after reload`          | Verify via store                  |
| persistence.spec.ts | `metronome setting persists after reload`  | Verify via store                  |
| persistence.spec.ts | `note edits persist after reload`          | Setup via store, verify via store |
| persistence.spec.ts | `deleted notes stay deleted after reload`  | Setup & verify via store          |
| persistence.spec.ts | `selection is not persisted`               | Setup & verify via store          |
| persistence.spec.ts | `playhead position resets on reload`       | Setup via store                   |
| piano-roll.spec.ts  | `deletes selected note with Delete key`    | Setup via store                   |
| piano-roll.spec.ts  | `deletes selected note with Backspace key` | Setup via store                   |
| piano-roll.spec.ts  | `deselects all notes with Escape key`      | Setup via store                   |

**Keep mouse-based** (testing actual interaction UX):

| File               | Test                                      | Reason                |
| ------------------ | ----------------------------------------- | --------------------- |
| piano-roll.spec.ts | `renders grid and keyboard`               | DOM visibility check  |
| piano-roll.spec.ts | `creates note on click-drag`              | Tests creation UX     |
| piano-roll.spec.ts | `selects note on click`                   | Tests click-to-select |
| piano-roll.spec.ts | `moves note by dragging body`             | Tests drag behavior   |
| piano-roll.spec.ts | `changes grid snap`                       | Tests UI control      |
| piano-roll.spec.ts | `selects multiple notes with Shift+click` | Tests shift+click     |
| piano-roll.spec.ts | `box selects notes with Shift+drag`       | Tests box select      |
| piano-roll.spec.ts | `resizes note from right edge`            | Tests edge resize     |
| piano-roll.spec.ts | `resizes note from left edge`             | Tests edge resize     |
| piano-roll.spec.ts | `moves note pitch by dragging vertically` | Tests vertical drag   |
| transport.spec.ts  | All 8 tests                               | Testing UI controls   |

### File Consolidation

- **Delete `audio.spec.ts`**: Single test overlaps with transport.spec.ts (audio loading already tested in play/pause tests)
- **Final structure**:
  ```
  e2e/
  ├── helpers.ts           # evaluateStore helper
  ├── piano-roll.spec.ts   # Mouse interaction tests (10) + keyboard tests (3)
  ├── transport.spec.ts    # Transport UI tests (8)
  ├── persistence.spec.ts  # State persistence tests (9)
  ```

## Current Test Structure

```
e2e/
├── helpers.ts           # evaluateStore helper for store access
├── piano-roll.spec.ts   # Note editing interactions (14 tests)
├── transport.spec.ts    # Playback/transport controls (8 tests)
├── persistence.spec.ts  # Save/restore functionality (9 tests)
```

**Total: 30 tests** (audio.spec.ts deleted as redundant)

## Patterns

### Constants (match `piano-roll.tsx`)

```typescript
const BEAT_WIDTH = 80;
const ROW_HEIGHT = 20;
```

### Test IDs Used

| Component        | Test ID                                      |
| ---------------- | -------------------------------------------- |
| Piano roll grid  | `piano-roll-grid`                            |
| Notes            | `note-{id}` (with `data-selected` attribute) |
| Play button      | `play-pause-button`                          |
| Tempo input      | `tempo-input`                                |
| Tap tempo        | `tap-tempo-button`                           |
| Metronome        | `metronome-toggle`                           |
| Time display     | `time-display`                               |
| Audio file input | `audio-file-input`                           |
| Audio file name  | `audio-file-name`                            |

### Common Patterns

**Create a note:**

```typescript
const grid = page.getByTestId("piano-roll-grid");
const gridBox = await grid.boundingBox();
await page.mouse.move(
  gridBox.x + BEAT_WIDTH * 0.5,
  gridBox.y + ROW_HEIGHT * 0.5,
);
await page.mouse.down();
await page.mouse.move(
  gridBox.x + BEAT_WIDTH * 1.5,
  gridBox.y + ROW_HEIGHT * 0.5,
);
await page.mouse.up();
```

**Load audio:**

```typescript
const fileInput = page.getByTestId("audio-file-input");
const testAudioPath = path.join(
  import.meta.dirname,
  "../public/test-audio.wav",
);
await fileInput.setInputFiles(testAudioPath);
await expect(page.getByTestId("audio-file-name")).toHaveText("test-audio.wav", {
  timeout: 5000,
});
```

**Wait for auto-save before reload:**

```typescript
await page.waitForTimeout(600); // Debounce is 500ms
await page.reload();
```

## Status

### Done

- [x] Added `e2e` to `tsconfig.json` include
- [x] Note resizing tests (left/right edges)
- [x] Multi-select tests (shift+click, box select)
- [x] Keyboard shortcut tests (Escape, Backspace)
- [x] Vertical pitch movement test
- [x] Playback tests (play/pause button, space bar)
- [x] Transport tests (tempo input, clamping, metronome, tap tempo)
- [x] Persistence tests (notes, tempo, grid snap, metronome, edits, deletions)
- [x] Transient state tests (selection/playhead reset on reload)
- [x] Expose `window.__store` in dev mode (in `project-store.ts`)
- [x] Add TypeScript types for window extension
- [x] Create `evaluateStore(page, fn)` helper in `e2e/helpers.ts`
- [x] Delete `audio.spec.ts` (redundant with transport tests)
- [x] Fix failing tests (metronome aria-pressed, play button icons, tempo clamping)
- [x] Refactor 9 persistence tests to use `evaluateStore` (all passing)

### In Progress

**Phase 2: Test refactoring**

- [ ] Refactor 3 piano-roll keyboard tests to use `evaluateStore`
  - Issue: Notes added via `evaluateStore` don't trigger React re-renders
  - Store state IS updated (verified), but DOM doesn't update
  - Needs investigation: Zustand subscription not firing from page.evaluate context?

### Remaining

**Phase 3: Additional test coverage (optional)**

- [ ] Audio offset drag test
- [ ] Volume slider tests
- [ ] Zoom/pan tests
- [ ] Timeline seek test

### Not Planned (manual testing preferred)

- Audio playback timing accuracy
- MIDI note sound verification
- Metronome beat alignment

## Running Tests

```bash
pnpm test-e2e
```

Playwright config auto-starts dev server if not running (`reuseExistingServer: !process.env.CI`).

## Notes

- Tests use `public/test-audio.wav` as fixture
- Persistence tests clear localStorage in `beforeEach` to ensure isolation
- Selection state is transient (not persisted) - this is intentional
